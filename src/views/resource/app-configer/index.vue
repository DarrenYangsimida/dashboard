<template>
  <v-container fluid>
    <BaseViewportHeader />

    <BaseBreadcrumb>
      <template #extend>
        <v-flex class="kubegems__full-right mr-3">
          <span class="text-body-2 kubegems__text">
            Nacos namespace <b> {{ Tenant().TenantName }}_{{ Project().ProjectName }} </b> Nacos group
            <b> {{ Environment().EnvironmentName }} </b>
          </span>
        </v-flex>
      </template>
    </BaseBreadcrumb>

    <v-card>
      <v-card-title class="py-4">
        <BaseFilter
          :default="{ items: [], text: '配置项', value: 'search' }"
          :filters="filters"
          :reload="false"
          @filter="customFilter"
          @refresh="m_filter_list"
        />

        <v-spacer />
        <v-menu left>
          <template #activator="{ on }">
            <v-btn icon>
              <v-icon color="primary" small v-on="on"> fas fa-ellipsis-v </v-icon>
            </v-btn>
          </template>
          <v-card>
            <v-card-text class="pa-2">
              <v-flex>
                <v-btn color="primary" text @click="openCreateDialog">
                  <v-icon left>mdi-key-plus</v-icon>
                  创建配置项
                </v-btn>
              </v-flex>
            </v-card-text>
          </v-card>
        </v-menu>
      </v-card-title>
      <v-data-table
        class="mx-4"
        :headers="headers"
        hide-default-footer
        :items="items"
        :items-per-page="params.size"
        no-data-text="暂无数据"
        :page.sync="params.page"
        @page-count="pageCount = $event"
      >
        <template #[`item.createdTime`]="{ item }">
          <span> {{ item.createdTime ? $moment(item.createdTime).format('lll') : '' }} </span>
        </template>
        <template #[`item.lastModifiedTime`]="{ item }">
          <span> {{ item.lastModifiedTime ? $moment(item.lastModifiedTime).format('lll') : '' }} </span>
        </template>
        <template #[`item.action`]="{ item, index }">
          <v-flex :id="`r${index}`" />
          <v-menu :attach="`#r${index}`" left>
            <template #activator="{ on }">
              <v-btn icon>
                <v-icon color="primary" x-small v-on="on"> fas fa-ellipsis-v </v-icon>
              </v-btn>
            </template>
            <v-card>
              <v-card-text class="pa-2">
                <v-flex>
                  <v-btn color="primary" small text @click="openEditDialog(item)"> 编辑/查看 </v-btn>
                </v-flex>
                <v-flex>
                  <v-btn color="primary" small text @click="openHistoryDialog(item)"> 历史 </v-btn>
                </v-flex>
                <v-flex>
                  <v-btn color="error" small text @click="openDeleteDialog(item, index)"> 删除 </v-btn>
                </v-flex>
              </v-card-text>
            </v-card>
          </v-menu>
        </template>
      </v-data-table>
      <BasePagination
        v-if="pageCount >= 1"
        v-model="params.page"
        :front-page="true"
        :page-count="pageCount"
        :size="params.size"
        @changepage="onPageIndexChange"
        @changesize="onPageSizeChange"
        @loaddata="appConfigList"
      />
    </v-card>

    <ConfigEditor
      :is-create="editor.isCreate"
      :item="editor.currentEditItem"
      :show-edit-dialog="editor.showEditDialog"
      @close="closeEditDialog"
      @submit="submitEditContent"
    />
    <DeleteItem
      :idx="editor.deleteIdx"
      :item="editor.currentDeleteItem"
      :show-delete-dialog="editor.showDeleteDialog"
      @close="closeDeleteDialog"
      @delete="submitDeleteItem"
    />
    <HistoryView
      :history-item="editor.currentHistoryItem"
      :show-history-dialog="editor.showHistoryDialog"
      @close="closeHistoryDialog"
      @rollback="rollbackHistory"
    />
  </v-container>
</template>

<script>
  import { mapGetters, mapState } from 'vuex';

  import { listConfigItems, pubConfigItems, delConfigItems } from './api/index.js';
  import ConfigEditor from './components/ConfigEditor';
  import DeleteItem from './components/DeleteItem';
  import HistoryView from './components/HistoryView';

  import BaseFilter from '@/mixins/base_filter';
  import { deepCopy } from '@/utils/helpers';

  export default {
    name: 'ConfigeUI',
    components: {
      ConfigEditor,
      DeleteItem,
      HistoryView,
    },
    mixins: [BaseFilter],
    data() {
      return {
        editor: {
          currentEditItem: {
            tenant: '',
            project: '',
            environment: '',
            application: '',
            key: '',
            value: '',
          },
          showEditDialog: false,
          isCreate: false,
          showDeleteDialog: false,
          currentDeleteItem: {},
          deleteIdx: -1,
          showHistoryDialog: false,
          currentHistoryItem: {},
        },
        items: [],
        itemsCopy: [],
        headers: [
          { text: 'app', value: 'application', align: 'start' },
          { text: 'dataid', value: 'key', align: 'start' },
          { text: 'create', value: 'createdTime', align: 'center', width: 260, sortable: false },
          { text: 'update', value: 'lastModifiedTime', align: 'center', width: 260, sortable: false },
          { text: 'operator', value: 'lastUpdateUser', align: 'center', width: 160, sortable: false },
          { text: '', value: 'action', align: 'center', width: 20, sortable: false },
        ],
        pageCount: 0,
        params: {
          page: 1,
          size: 10,
        },
        filters: [{ text: '配置名称', value: 'search', items: [] }],
      };
    },
    computed: {
      ...mapState(['JWT', 'Admin', 'AdminViewport', 'MessageStreamWS']),
      ...mapGetters(['Tenant', 'Environment', 'Project']),
    },
    mounted() {
      this.appConfigList();
    },
    methods: {
      async appConfigList() {
        const datas = await listConfigItems(
          this.Tenant().TenantName || '',
          this.Project().ProjectName || '',
          this.Environment().EnvironmentName || '',
        );
        this.items = datas;
        this.itemsCopy = deepCopy(datas);
      },
      customFilter() {
        if (this.$route.query.search && this.$route.query.search.length > 0) {
          this.items = this.itemsCopy.filter((item) => {
            return (
              item.application &&
              item.application.toLocaleLowerCase().indexOf(this.$route.query.search.toLocaleLowerCase()) > -1
            );
          });
        } else {
          this.items = this.itemsCopy;
        }
        // this.m_table_generateSelectResource()
      },
      onPageSizeChange(size) {
        this.params.page = 1;
        this.params.size = size;
      },
      onPageIndexChange(page) {
        this.params.page = page;
      },
      openEditDialog(item) {
        this.editor.currentEditItem = {
          tenant: (this.Tenant() || { TenantName: '' }).TenantName,
          project: (this.Project() || { ProjectName: '' }).ProjectName,
          environment: (this.Environment() || { EnvironmentName: '' }).EnvironmentName,
          ...item,
        };
        this.editor.isCreate = false;
        this.editor.showEditDialog = true;
      },
      openCreateDialog() {
        this.editor.currentEditItem = {
          tenant: (this.Tenant() || { TenantName: '' }).TenantName,
          project: (this.Project() || { ProjectName: '' }).ProjectName,
          environment: (this.Environment() || { EnvironmentName: '' }).EnvironmentName,
          application: '',
          key: '',
          value: '',
        };
        this.editor.isCreate = true;
        this.editor.showEditDialog = true;
      },
      openDeleteDialog(item, idx) {
        this.editor.currentDeleteItem = item;
        this.editor.deleteIdx = idx;
        this.editor.showDeleteDialog = true;
      },
      closeEditDialog() {
        this.editor.showEditDialog = false;
        this.editor.currentEditItem = {
          tenant: (this.Tenant() || { TenantName: '' }).TenantName,
          project: (this.Project() || { ProjectName: '' }).ProjectName,
          environment: (this.Environment() || { EnvironmentName: '' }).EnvironmentName,
          application: '',
          key: '',
          value: '',
        };
      },
      closeDeleteDialog() {
        this.editor.currentDeleteItem = {};
        this.editor.deleteIdx = -1;
        this.editor.showDeleteDialog = false;
      },
      closeHistoryDialog() {
        this.editor.showHistoryDialog = false;
        this.editor.currentHistoryItem = {};
      },
      async openHistoryDialog(item) {
        this.editor.showHistoryDialog = true;
        this.editor.currentHistoryItem = item;
      },
      async submitDeleteItem(idx) {
        await delConfigItems(
          this.editor.currentDeleteItem.tenant,
          this.editor.currentDeleteItem.project,
          this.editor.currentDeleteItem.application,
          this.editor.currentDeleteItem.environment,
          this.editor.currentDeleteItem.key,
        );
        this.items.splice(idx, 1);
        this.closeDeleteDialog();
      },
      rollbackHistory(ritem) {
        const citem = this.items.find((item) => {
          return item.key === ritem.key;
        });
        citem.value = ritem.value;
        citem.lastModifiedTime = ritem.lastModifiedTime;
        citem.createdTime = ritem.createdTime;
        citem.lastUpdateUser = ritem.lastUpdateUser;
      },
      async submitEditContent(editItem, isCreate) {
        if (editItem.value === this.editor.currentEditItem.value) {
          this.closeEditDialog();
          return;
        }
        const res = await pubConfigItems(
          editItem.tenant,
          editItem.project,
          editItem.application,
          editItem.environment,
          editItem.key,
          editItem.value,
        );
        if (isCreate) {
          this.items.push(res);
        } else {
          const citem = this.items.find((item) => {
            return item.key === editItem.key;
          });
          citem.value = editItem.value;
          citem.lastModifiedTime = res.lastModifiedTime;
          citem.createdTime = res.createdTime;
          citem.lastUpdateUser = res.lastUpdateUser;
        }
        this.closeEditDialog();
      },
    },
  };
</script>
